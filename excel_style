import pandas as pd
from openpyxl.styles import PatternFill, Font, Alignment
from openpyxl.utils import get_column_letter

fichier_excel = "reporting_data.xlsx"

# ======================
# STYLE GLOBAL
# ======================
HEADER_FILL = PatternFill(fill_type="solid", fgColor="1F4E78")
HEADER_FONT = Font(color="FFFFFF", bold=True)
CENTER_ALIGN = Alignment(horizontal="center")

def styliser_feuille(sheet, header_row):
    """Applique le même style à toutes les feuilles"""
    
    if sheet.max_row < header_row or sheet.max_column < 1:
        return

    for col in range(1, sheet.max_column + 1):
        cell = sheet.cell(row=header_row, column=col)
        cell.fill = HEADER_FILL
        cell.font = HEADER_FONT
        cell.alignment = CENTER_ALIGN
        sheet.column_dimensions[get_column_letter(col)].width = 20

    # Freeze sous le header
    sheet.freeze_panes = f"A{header_row + 1}"

    # Filtre sécurisé
    sheet.auto_filter.ref = (
        f"A{header_row}:{get_column_letter(sheet.max_column)}{sheet.max_row}"
    )


with pd.ExcelWriter(fichier_excel, engine="openpyxl") as writer:

    # ======================
    # ONGLET INDICATEURS
    # ======================
    df_indicateurs.to_excel(
        writer,
        sheet_name="Indicateurs",
        index=False,
        startrow=2
    )

    workbook = writer.book
    sheet_ind = workbook["Indicateurs"]

    # Ligne d'information
    sheet_ind["A1"] = "Rapport quotidien – Suivi des indicateurs clés"
    sheet_ind["A1"].font = Font(bold=True)
    sheet_ind.merge_cells(
        start_row=1,
        start_column=1,
        end_row=1,
        end_column=df_indicateurs.shape[1]
    )

    # Style indicateurs (header ligne 3)
    styliser_feuille(sheet_ind, header_row=3)

    # ======================
    # AUTRES ONGLETs
    # ======================
    autres_onglets = {
        "Transactions": df_transactions,
        "Soldes": df_soldes,
        "Anomalies": df_anomalies
    }

    for nom, df in autres_onglets.items():
        df.to_excel(writer, sheet_name=nom, index=False)
        sheet = workbook[nom]

        # Style standard (header ligne 1)
        styliser_feuille(sheet, header_row=1)
